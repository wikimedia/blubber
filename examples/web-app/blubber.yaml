# syntax = registry:5000/blubber:test
version: v4
variants:
  assets:
    base: node:22-bookworm
    lives:
      in: /src
    builders:
      - node:
          requirements: [package.json, package-lock.json]
      - custom:
          requirements:
            - webpack.config.js
            - ./src/
          command: [npm, run, build]
  build:
    base: golang:1.23
    runs:
      environment:
        CGO_ENABLED: "0"
        GOCACHE: /var/cache/go
    builders:
      - custom:
          requirements: [go.mod, main.go]
          command: [go, build]
          caches: [ "${GOCACHE}" ]
          mounts:
            - from: assets
              source: /src/dist
              destination: ./dist
  webserver:
    copies:
      - from: build
        source: ./web-app
        destination: /usr/bin/web-app
    entrypoint: [/usr/bin/web-app]
